<template>
  <!-- ğŸ”¹ ìµœìƒë‹¨ ì¸ì‚¬ + (í˜„ì¬ í˜ì´ì§€ í‘œì‹œ) + ë¡œê·¸ì•„ì›ƒ -->
  <div class="top-bar">
    <!-- ì™¼ìª½: ì¸ì‚¬ë§ -->
    <div class="top-left">
      <span class="welcome-text">{{ nickname }}ë‹˜ ë°˜ê°‘ìŠµë‹ˆë‹¤.</span>
    </div>

    <!-- ê°€ìš´ë°: í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ -->
    <div class="top-center">
      <span class="page-tag">ê´€ë¦¬ì í˜ì´ì§€</span>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ë¡œê·¸ì•„ì›ƒ -->
    <div class="top-right">
      <button class="logout-btn" @click="logout">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <!-- ì„¹ì…˜ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ë Œë” -->
<!-- 00100_HeartbeatCardê°€ ì˜¬ë ¤ì£¼ëŠ” ì´ë²¤íŠ¸ í˜¸í™˜ -->
<!-- 00300_UserSearchBarê°€ ì˜¬ë ¤ì£¼ëŠ” ì´ë²¤íŠ¸ í˜¸í™˜ -->
<!-- 00400_UserTableê°€ ì˜¬ë ¤ì£¼ëŠ” ì´ë²¤íŠ¸ í˜¸í™˜ -->
<!-- 00500_UserActionsPanelì´ ì˜¬ë ¤ì£¼ëŠ” ì´ë²¤íŠ¸ í˜¸í™˜ -->
<!-- 00200_ServerStatusCardì—ì„œ ì“°ëŠ” props í˜¸í™˜ -->
 <!-- 00400_UserTableì—ì„œ ì“°ëŠ” props í˜¸í™˜ -->
<!-- 00500_UserActionsPanelì—ì„œ ì“°ëŠ” props í˜¸í™˜ -->
<!-- 00600_LogViewerì—ì„œ ì“°ëŠ” props í˜¸í™˜ -->

  <template v-if="sectionsInOrder.length">
    <component
      v-for="(Comp, idx) in sectionsInOrder"
      :key="idx"
      :is="Comp"




      @latency="onLatency"     
      @search="onSearch"       
      @selected="onSelected"   
      @acted="onActed"         
      :last-latency="lastLatency"  
      :filters="userFilters"      
      :selected-user="selectedUser"
      :logs="clientLogs"           
    />
  </template>

  <!-- ì•ˆì „ë§: ì„¹ì…˜ì´ 0ê°œë©´ ì›ì¸ ì¶”ì  ë©”ì‹œì§€ ë…¸ì¶œ -->
  <div v-else class="empty-hint">
    ì„¹ì…˜ ëª¨ë“ˆì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê²½ë¡œ/íŒŒì¼ëª…ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.
    <div class="hint-small">ê¸°ëŒ€ ê²½ë¡œ: /src/components/04910_Page9_Admin/*.vue (ì˜ˆ: 00100_HeartbeatCard.vue)</div>
  </div>
</template>

<script setup lang="ts">
// ------------------------------------------------------
// AdminDashboard.vue (auto import & order by filename)
// - ì ˆëŒ€ê²½ë¡œ(/src/...)ë¡œ glob â†’ ê²½ë¡œ/ìºì‹œ ì´ìŠˆ ìµœì†Œí™”
// - íŒŒì¼ëª…(00100_~) ì‚¬ì „ìˆœ ì •ë ¬ë¡œ ë Œë” ìˆœì„œ ê³ ì •
// - í’ë¶€í•œ ë¡œê·¸ë¡œ ë¡œë”©/ì‹¤íŒ¨ ì›ì¸ ì¶”ì 
// - ìƒë‹¨ë°”: ì¸ì‚¬/í˜„ì¬í˜ì´ì§€/ë¡œê·¸ì•„ì›ƒ
// - í•˜ìœ„ ì„¹ì…˜ê³¼ì˜ ì´ë²¤íŠ¸/propsë¥¼ ë¶€ëª¨ì—ì„œ ì¤‘ê³„(ì„ íƒ ìœ ì €, í•„í„°, latency, ë¡œê·¸)
// ------------------------------------------------------
import type { Component } from 'vue'
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'

// âœ… ì ˆëŒ€ê²½ë¡œ glob (eager: true â†’ ì¦‰ì‹œ import)
//   - 00100_HeartbeatCard.vue
//   - 00200_ServerStatusCard.vue
//   - 00300_UserSearchBar.vue
//   - 00400_UserTable.vue
//   - 00500_UserActionsPanel.vue
//   - 00600_LogViewer.vue
//   - 00700_StatsSummary.vue
const modules = import.meta.glob(
  '/src/components/04910_Page9_Admin/*.vue',
  { eager: true }
) as Record<string, { default: Component }>

// ğŸ” ë¡œë“œëœ ëª¨ë“ˆ ë¡œê·¸
console.group('[AdminDashboard] auto-load sections')
Object.keys(modules).sort().forEach((k) => console.log(' - found:', k))
console.groupEnd()

// âœ… íŒŒì¼ ê²½ë¡œë¥¼ ì´ë¦„ìˆœ ì •ë ¬ â†’ default exportë§Œ ì¶”ì¶œ
const sectionsInOrder: Component[] = Object
  .entries(modules)
  .sort(([a], [b]) => a.localeCompare(b))       // '00100_' â†’ '01200_' ìˆœì„œ
  .map(([key, mod]) => {
    const comp = mod?.default
    if (!comp) console.warn('[AdminDashboard] missing default export:', key)
    else console.log('[AdminDashboard] register component:', key)
    return comp
  })
  .filter(Boolean) as Component[]

// ğŸ“Œ ê°œìˆ˜ ë¡œê·¸
console.info('[AdminDashboard] total sections:', sectionsInOrder.length)

// ============================
// ìƒë‹¨ ì¸ì‚¬/ë¡œê·¸ì•„ì›ƒ ë°” ê´€ë ¨
// ============================
const router = useRouter()
const nickname = ref<string>('')        // í™”ë©´ í‘œì‹œìš© ë‹‰ë„¤ì„
const meRole = ref<string>('')          // ì—­í• (role) (master í™•ì¸ìš©)

// NOTE: /api/meëŠ” ì„¸ì…˜ ê¸°ë°˜. CORS/í”„ë¡ì‹œ í™˜ê²½ì—ì„œ ì¿ í‚¤ í¬í•¨ í•„ìš” ì‹œ fetchì— credentials: 'include' ê¶Œì¥.
// ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœ fetch ì‚¬ìš© (axios ì‚¬ìš© ì‹œ withCredentials: true)
onMounted(async () => {
  try {
    console.time('[AdminDashboard] GET /api/me')
    const r = await fetch('/api/me', { credentials: 'include' })
    console.timeEnd('[AdminDashboard] GET /api/me')
    if (!r.ok) {
      console.warn('[AdminDashboard] /api/me not ok', r.status)
      return
    }
    const data = await r.json()
    nickname.value = data?.user?.nickname || ''
    meRole.value = data?.user?.role || ''
    console.log('[AdminDashboard] me:', { nickname: nickname.value, role: meRole.value })
  } catch (err) {
    console.error('âŒ [AdminDashboard] /api/me ì‹¤íŒ¨:', err)
  }
})

// ë¡œê·¸ì•„ì›ƒ
const logout = async () => {
  try {
    console.time('[AdminDashboard] POST /api/logout')
    const r = await fetch('/api/logout', { method: 'POST', credentials: 'include' })
    console.timeEnd('[AdminDashboard] POST /api/logout')
    if (!r.ok) {
      console.warn('[AdminDashboard] logout not ok', r.status)
      return
    }
    console.info('[AdminDashboard] ë¡œê·¸ì•„ì›ƒ ì„±ê³µ â†’ /login ì´ë™')
    router.push('/login')
  } catch (err) {
    console.error('âŒ [AdminDashboard] ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', err)
  }
}

// ============================
// ì„¹ì…˜ ê°„ ìƒíƒœ ì¤‘ê³„ (ì„ íƒ)
// - 00100ì´ ë³´ë‚¸ latencyë¥¼ 00200ì— propsë¡œ ì „ë‹¬
// - 00300ì˜ ê²€ìƒ‰ì–´ë¥¼ 00400ì— propsë¡œ ì „ë‹¬
// - 00400ì˜ ì„ íƒ ìœ ì €ë¥¼ 00500ì— propsë¡œ ì „ë‹¬
// - ì„ì˜ì˜ ë¡œê·¸ë¥¼ 00600ì— ì „ë‹¬
// ============================
const lastLatency = ref<number|null>(null)
const userFilters = ref<{ q: string }>({ q: '' })
const selectedUser = ref<any>(null)
const clientLogs = ref<{ at: string; level: string; msg: string }[]>([])

function pushLog(level: 'INFO'|'WARN'|'ERROR', msg: string) {
  clientLogs.value.unshift({ at: new Date().toISOString(), level, msg })
  // í•„ìš” ì‹œ ê¸¸ì´ ì œí•œ
  if (clientLogs.value.length > 200) clientLogs.value.pop()
}

function onLatency(ms: number) {
  lastLatency.value = ms
  pushLog('INFO', `[DASH] heartbeat latency: ${ms}ms`)
  console.log('[AdminDashboard] onLatency', ms)
}

function onSearch(filters: { q: string }) {
  userFilters.value = { ...filters }
  pushLog('INFO', `[DASH] search filters: ${JSON.stringify(filters)}`)
  console.log('[AdminDashboard] onSearch', filters)
}

function onSelected(user: any) {
  selectedUser.value = user
  pushLog('INFO', `[DASH] selected user: ${user?.username || '(none)'}`)
  console.log('[AdminDashboard] onSelected', user)
}

function onActed(payload: any) {
  pushLog('INFO', `[DASH] action: ${JSON.stringify(payload)}`)
  console.log('[AdminDashboard] onActed', payload)
}
</script>

<style scoped>
/* ê¸°ë³¸ ê°€ë…ì„±: ê²€ì • */
:host { color: #000; }

/* ğŸ”¹ ìµœìƒë‹¨ í—¤ë” ë°”: 3ë¶„í• (ì™¼/ê°€ìš´ë°/ì˜¤ë¥¸ìª½) */
.top-bar {
  display: grid;
  grid-template-columns: 1fr auto 1fr; /* ì¢Œ/ì¤‘ì•™/ìš° */
  align-items: center;
  gap: 12px;
  padding: 0.5rem 0.75rem;
  background-color: #f1f1f1;  /* ì˜…ì€ íšŒìƒ‰ ë°°ê²½ */
  border-bottom: 1px solid #ccc;
  font-size: 0.95rem;
  color: #000;                /* í…ìŠ¤íŠ¸ ê²€ì • */
}
.top-left { justify-self: start; }
.top-center { justify-self: center; }
.top-right { justify-self: end; }

.welcome-text {
  font-weight: bold;
  color: #000;
}
.page-tag {
  display: inline-block;
  padding: 2px 8px;
  border: 1px solid #333;
  border-radius: 999px;
  font-size: 12px;
  color: #000;
  background: #fff;
}
.logout-btn {
  background: none;
  border: 1px solid #333;
  padding: 6px 10px;
  border-radius: 8px;
  color: black;
  cursor: pointer;
}

/* ì„¹ì…˜ ë¹„ì–´ìˆì„ ë•Œ íŒíŠ¸ */
.empty-hint {
  color: #000;
  padding: 16px;
  font-size: 14px;
  opacity: 0.9;
}
.hint-small {
  margin-top: 6px;
  font-size: 12px;
  color: #444;
}
</style>
