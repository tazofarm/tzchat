<template>
  <div class="chatroom-container">
    <!-- â–’â–’ ìƒë‹¨ë°” â–’â–’ -->
    <div class="chatroom-header">
      <!-- ë’¤ë¡œê°€ê¸°: ì•„ì´ì½˜ ë²„íŠ¼ -->
      <ion-button size="small" fill="clear" @click="goBack" aria-label="ë’¤ë¡œê°€ê¸°">
        <ion-icon :icon="icons.chevronBackOutline" />
      </ion-button>

      <!-- ìƒëŒ€ ë‹‰ë„¤ì„(í”„ë¡œí•„ ì´ë™ ê°€ëŠ¥) -->
      <div class="chat-title" @click="goToPartnerProfile" role="button" tabindex="0">
        <ion-icon :icon="icons.personCircleOutline" class="title-avatar" aria-hidden="true" />
        <span class="title-text">{{ partnerNickname }}</span>
      </div>
    </div>

    <!-- â–’â–’ ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ â–’â–’ -->
    <div class="chat-messages" ref="chatScroll">
      <div
        v-for="msg in messages"
        :key="msg._id"
        class="message-row"
        :class="{ mine: msg.sender && msg.sender._id === myId }"
      >
        <!-- ë‚˜ì˜ ë©”ì‹œì§€ -->
        <template v-if="msg.sender && msg.sender._id === myId">
          <div class="my-message">
            <span class="time">
              <ion-icon :icon="icons.timeOutline" class="time-icon" aria-hidden="true" />
              {{ formatTime(msg.createdAt) }}
            </span>
            <div class="bubble">
              <template v-if="msg.imageUrl">
                <img
                  :src="getImageUrl(msg.imageUrl)"
                  class="chat-image"
                  @click="openImage(getImageUrl(msg.imageUrl))"
                  alt="ë³´ë‚¸ ì´ë¯¸ì§€"
                />
              </template>
              <template v-else>
                {{ msg.content }}
              </template>
            </div>
          </div>
        </template>

        <!-- ìƒëŒ€ ë©”ì‹œì§€ -->
        <template v-else>
          <div class="other-message">
            <div class="bubble">
              <template v-if="msg.imageUrl">
                <img
                  :src="getImageUrl(msg.imageUrl)"
                  class="chat-image"
                  @click="openImage(getImageUrl(msg.imageUrl))"
                  alt="ìˆ˜ì‹  ì´ë¯¸ì§€"
                />
              </template>
              <template v-else>
                {{ msg.content }}
              </template>
            </div>
            <span class="time">
              <ion-icon :icon="icons.timeOutline" class="time-icon" aria-hidden="true" />
              {{ formatTime(msg.createdAt) }}
            </span>
          </div>
        </template>
      </div>
    </div>

    <!-- â–’â–’ ì…ë ¥ì°½ â–’â–’ -->
    <div class="chat-input-wrapper">
      <!-- ì´ëª¨ì§€ í”¼ì»¤ -->
      <div v-if="showEmoji" class="emoji-picker-wrapper">
        <emoji-picker @emoji-click="insertEmoji"></emoji-picker>
      </div>

      <div class="chat-input">
        <!-- íŒŒì¼ ì²¨ë¶€ -->
        <ion-button size="small" fill="outline" @click="triggerFileInput" aria-label="íŒŒì¼ ì²¨ë¶€">
          <ion-icon :icon="icons.attachOutline" />
        </ion-button>
        <input
          type="file"
          accept="image/*"
          ref="fileInput"
          style="display: none"
          @change="uploadImage"
        />

        <!-- ì´ëª¨ì§€ í† ê¸€ -->
        <ion-button size="small" fill="outline" @click="toggleEmoji" aria-label="ì´ëª¨ì§€ ì—´ê¸°">
          <ion-icon :icon="icons.happyOutline" />
        </ion-button>

        <!-- í…ìŠ¤íŠ¸ ì…ë ¥ -->
        <textarea
          v-model="newMessage"
          placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
          @keydown="handleKeydown"
          rows="1"
        ></textarea>

        <!-- ì „ì†¡ -->
        <ion-button size="small" color="primary" @click="sendMessage" aria-label="ì „ì†¡">
          <ion-icon :icon="icons.sendOutline" />
        </ion-button>
      </div>
    </div>

    <!-- â–’â–’ ì´ë¯¸ì§€ í™•ëŒ€ íŒì—… â–’â–’ -->
    <transition name="fade">
      <div v-if="enlargedImage" class="image-modal" @click.self="enlargedImage = ''">
        <div class="image-wrapper">
          <button class="close-button" @click="enlargedImage = ''" aria-label="ë‹«ê¸°">Ã—</button>
          <img :src="enlargedImage" class="modal-image" @click.stop alt="í™•ëŒ€ ì´ë¯¸ì§€" />
        </div>
      </div>
    </transition>
  </div>
</template>

<script setup>
// ====================================================================
// ChatRoom
// - ê¸°ì¡´ ë¡œì§ ìœ ì§€: ë©”ì‹œì§€ ë¡œë”©/ì „ì†¡, ì´ë¯¸ì§€ ì—…ë¡œë“œ, ì†Œì¼“ í†µì‹ 
// - UI ì •ë¦¬ + Ionicons ì•„ì´ì½˜ ì ìš©
// - ê¸€ììƒ‰: ê²€ì •(#000) ê³ ì • / ì£¼ì„&ë¡œê·¸ ê°•í™”
// ====================================================================
import { ref, onMounted, nextTick, onBeforeUnmount } from 'vue'
import { IonButton, IonIcon } from '@ionic/vue'
import { useRoute, useRouter } from 'vue-router'
import axios from '@/lib/axiosInstance'
import { io } from 'socket.io-client'
import 'emoji-picker-element'

// Ionicons
import {
  chevronBackOutline,
  personCircleOutline,
  attachOutline,
  happyOutline,
  sendOutline,
  timeOutline,
} from 'ionicons/icons'

const icons = {
  chevronBackOutline,
  personCircleOutline,
  attachOutline,
  happyOutline,
  sendOutline,
  timeOutline,
}

// â–’ ì†Œì¼“ ì—°ê²°
const socket = io('http://localhost:2000', { withCredentials: true })

// â–’ ë¼ìš°íŒ…
const route = useRoute()
const router = useRouter()
const roomId = route.params.id

// â–’ ìƒíƒœ
const myId = ref('')
const partnerId = ref('')
const partnerNickname = ref('ìƒëŒ€ë°©')
const messages = ref([])
const newMessage = ref('')
const chatScroll = ref(null)
const showEmoji = ref(false)
const fileInput = ref(null)
const enlargedImage = ref('')

// â–’ ìœ í‹¸
const openImage = (url) => { enlargedImage.value = url }
const getImageUrl = (path) => (path?.startsWith('http') ? path : `http://localhost:2000${path}`)

const formatTime = (isoString) =>
  new Date(isoString).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })

const scrollToBottom = async () => {
  await nextTick()
  if (chatScroll.value) chatScroll.value.scrollTop = chatScroll.value.scrollHeight
}

// â–’ ë°ì´í„° ë¡œë“œ
const loadMessages = async () => {
  console.time('[LOAD] GET /api/chatrooms/:id')
  try {
    const res = await axios.get(`/api/chatrooms/${roomId}`)
    messages.value = res.data.messages || []
    myId.value = res.data.myId
    const partner = res.data.participants.find((p) => p._id !== myId.value)
    partnerNickname.value = partner?.nickname || 'ìƒëŒ€ë°©'
    partnerId.value = partner?._id || ''
    console.log('âœ… ì±„íŒ…ë°© ë¡œë“œ:', { roomId, myId: myId.value, partnerId: partnerId.value })
    scrollToBottom()
  } catch (err) {
    console.error('âŒ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err)
  } finally {
    console.timeEnd('[LOAD] GET /api/chatrooms/:id')
  }
}

// â–’ ì „ì†¡(í…ìŠ¤íŠ¸)
const sendMessage = async () => {
  if (!newMessage.value.trim()) return
  try {
    const res = await axios.post(`/api/chatrooms/${roomId}/message`, {
      content: newMessage.value,
      type: 'text',
    })
    newMessage.value = ''
    socket.emit('chatMessage', { roomId, message: res.data })
  } catch (err) {
    console.error('âŒ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', err)
  }
}

// â–’ ì´ë¯¸ì§€ ì—…ë¡œë“œ + ì „ì†¡
const uploadImage = async (e) => {
  const file = e.target.files[0]
  if (!file) return
  const formData = new FormData()
  formData.append('image', file)

  try {
    console.time('[UPLOAD] /api/chatrooms/upload-image')
    const uploadRes = await axios.post('/api/chatrooms/upload-image', formData, {
      headers: { 'Content-Type': 'multipart/form-data' },
      withCredentials: true,
    })
    console.timeEnd('[UPLOAD] /api/chatrooms/upload-image')

    const imageUrl = uploadRes.data.imageUrl
    const messageRes = await axios.post(
      `/api/chatrooms/${roomId}/message`,
      { content: imageUrl, type: 'image' },
      { withCredentials: true }
    )
    socket.emit('chatMessage', { roomId, message: messageRes.data })
  } catch (err) {
    console.error('âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', err)
  } finally {
    // ê°™ì€ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡ ê°’ ì´ˆê¸°í™”
    if (fileInput.value) fileInput.value.value = ''
  }
}

// â–’ ì…ë ¥ í¸ì˜
const handleKeydown = (e) => {
  if (e.key === 'Enter') {
    if (e.shiftKey) return
    e.preventDefault()
    sendMessage()
  }
}
const triggerFileInput = () => fileInput.value?.click()
const insertEmoji = (event) => (newMessage.value += event.detail.unicode)
const toggleEmoji = () => (showEmoji.value = !showEmoji.value)

// â–’ ìƒëª…ì£¼ê¸°
onMounted(async () => {
  await loadMessages()
  socket.emit('joinRoom', roomId)
  socket.on('chatMessage', (msg) => {
    const message = msg.message || msg
    const targetId = msg.chatRoom?._id || msg.chatRoom
    if (targetId === roomId) {
      messages.value.push(message)
      scrollToBottom()
    }
  })
})
onBeforeUnmount(() => {
  socket.emit('leaveRoom', roomId)
  socket.off('chatMessage')
  socket.disconnect()
})

// â–’ ë‚´ë¹„ê²Œì´ì…˜
const goBack = () => router.push('/home/4page')
const goToPartnerProfile = () => {
  if (partnerId.value) router.push(`/home/user/${partnerId.value}`)
}
</script>

<style scoped>
/* ==========================================================
   ChatRoom - ê¹”ë”/ì»´íŒ©íŠ¸ ìŠ¤íƒ€ì¼
   - ê¸°ë³¸ ê¸€ììƒ‰: #000
   - ì—¬ë°±/ë¼ì¸/ì•„ì´ì½˜ í¬ê¸° í‘œì¤€í™”
   ========================================================== */

/* ì „ì²´ ë˜í¼ */
.chatroom-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  min-height: 0;
  width: 100%;
  background: #fefefe;
  color: #000;
  overscroll-behavior: contain;
}

/* ìƒë‹¨ë°” */
.chatroom-header {
  display: grid;
  grid-template-columns: auto 1fr;   /* â† ë²„íŠ¼ | ì œëª© */
  align-items: center;
  gap: 8px;
  height: 50px;
  padding: 0 12px;
  background: #f1f1f1;
  border-bottom: 1px solid #ddd;
  color: #000;
  box-sizing: border-box;
}
.chatroom-header ion-button {
  --padding-start: 8px;
  --padding-end: 8px;
  min-height: 36px;
  --border-radius: 10px;
}

/* ì œëª©(ì•„ì´ì½˜ + í…ìŠ¤íŠ¸) */
.chat-title {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  user-select: none;
  cursor: pointer;
  outline: none;
}
.chat-title:focus-visible {
  box-shadow: 0 0 0 3px rgba(59,130,246,.35);
  border-radius: 8px;
}
.title-avatar { font-size: 18px; color: #111; }
.title-text {
  font-weight: 700;
  font-size: clamp(15px, 2.6vw, 16px);
  line-height: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-decoration: underline;
}

/* ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ */
.chat-messages {
  flex: 1 1 0;
  min-height: 0;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 12px;
  background: #fafafa;
  scrollbar-gutter: stable;
}

/* ë©”ì‹œì§€ í–‰ */
.message-row { margin-bottom: 8px; }
.other-message,
.my-message {
  display: flex;
  align-items: flex-end;
  gap: 6px; /* ì‹œê°„/ë§í’ì„  ê°„ê²© */
}
.other-message { justify-content: flex-start; }
.my-message    { justify-content: flex-end; }

/* ë§í’ì„  */
.bubble {
  max-width: min(75%, 640px);
  padding: 8px 12px;
  border-radius: 12px;
  background-color: #e0e0e0; /* ìƒëŒ€ */
  color: #000;
  word-break: break-word;
  white-space: pre-wrap;
  font-size: clamp(14px, 2.6vw, 15px);
  line-height: 1.4;
  box-shadow: 0 1px 0 rgba(0,0,0,.05);
}
.my-message .bubble { background-color: #d2f1ff; } /* ë‚´ ë©”ì‹œì§€ */

/* ì‹œê°„ */
.time {
  font-size: 12px;
  color: #7a7a7a;
  white-space: nowrap;
  margin: 0 4px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
.time-icon { font-size: 14px; color: #7a7a7a; }

/* ì´ë¯¸ì§€ ë©”ì‹œì§€ */
.chat-image {
  max-width: 180px;
  max-height: 180px;
  border-radius: 10px;
  cursor: pointer;
  display: block;
}

/* ì…ë ¥ ë˜í¼ */
.chat-input-wrapper {
  position: relative;
  background: #fff;
  padding-bottom: env(safe-area-inset-bottom, 0px);
  border-top: 1px solid #ccc;
}

/* ì…ë ¥ ë°”: ğŸ“ | ğŸ˜Š | ì…ë ¥ | ì „ì†¡ */
.chat-input {
  display: grid;
  grid-template-columns: auto auto 1fr auto;
  align-items: end;
  gap: 8px;
  padding: 8px 12px;
  background: #fff;
  box-sizing: border-box;
}
.chat-input ion-button {
  --border-radius: 10px;
  min-height: 36px;
}

/* textarea */
.chat-input textarea {
  flex: 1 1 auto;
  padding: 8px 10px;
  border: 1px solid #ddd;
  border-radius: 10px;
  margin: 0;
  font-size: clamp(14px, 2.6vw, 15px);
  background: #fff;
  color: #000;
  resize: none;
  line-height: 1.4;
  min-height: 36px;
  max-height: 120px;
}
.chat-input textarea::placeholder { color: #999; }

/* ì´ëª¨ì§€ í”¼ì»¤ */
.emoji-picker-wrapper {
  position: absolute;
  left: 12px;
  bottom: calc(48px + env(safe-area-inset-bottom,
